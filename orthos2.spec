# Copyright (c) 2020 SUSE LLC
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.

# Please submit bugfixes or comments via https://bugs.opensuse.org/

Name:           orthos2
Version:        0.1
Release:        0
Summary:        Machine administration
Url:            https://github.com/openSUSE/orthos2

Group:          Productivity/Networking/Boot/Servers
%{?systemd_ordering}

License:        GPL-2.0-or-later
Source:         orthos2-%{version}.tar.xz
BuildArch:      noarch

BuildRequires:  systemd-rpm-macros
BuildRequires:  python3-setuptools
BuildRequires:  python3-devel
%if 0%{?suse_version}
BuildRequires:  python-rpm-macros
%endif

# Finds python dependencies based on egg info generated by setup.py
# Theoretically distro independent and should work this way, but has
# quite some pitfalls. Only works after SLE 15 SP2, due to build service
# restrictions (be careful, there they messed it up and
# python_enable_dependency_generator macro is defined, but does not do
# anything. This check still also needs to explicitly check for SLE 15 SP2...
%{?python_enable_dependency_generator}
%if ! (%{defined python_enable_dependency_generator} || %{defined python_disable_dependency_generator})
%if 0%{?suse_version}
Requires:  python%{python3_pkgversion}-Django
%else
Requires:  python%{python3_pkgversion}-django
%endif
Requires:  python3-django-extensions
Requires:  python3-paramiko
Requires:  python3-djangorestframework
Requires:  python3-validators
Requires:  python3-netaddr
Requires:  nginx
Requires:  uwsgi
Requires:  uwsgi-python3
%endif
Requires:  /sbin/service

Provides: orthos2-%{version}-%{release}

%description
Orthos is the machine administration tool of the development network at SUSE. It is used for following tasks:

    getting the state of the machine
    overview about the hardware
    overview about the installed software (installations)
    reservation of the machines
    generating the DHCP configuration (via Cobbler)
    reboot the machines remotely
    managing remote (serial) consoles


%prep
%setup

%build
%py3_build


%install
%py3_install


#systemd
mkdir -p %{buildroot}%{_unitdir}
install orthos2_taskmanager.service %{buildroot}%{_unitdir}
install orthos2.service %{buildroot}%{_unitdir}
install orthos2.socket %{buildroot}%{_unitdir}

%if 0%{?suse_version}
mkdir -p %{buildroot}%{_sbindir}
ln -sf service %{buildroot}%{_sbindir}/rcorthos2_taskmanager
ln -sf service %{buildroot}%{_sbindir}/rcorthos2
%endif
# ToDo: Move this into setup.py?
install -D orthos2_uwsgi.ini %{buildroot}/usr/share/orthos2/orthos2_uwsgi.ini
install -D orthos2_nginx.conf %{buildroot}%{_sysconfdir}/nginx/conf.d/orthos2_nginx.conf
mkdir -p /%{buildroot}/srv/www/orthos2/
cp -r orthos2/static /%{buildroot}/srv/www/orthos2/
cp -r orthos2/data/fixtures %{buildroot}%{python3_sitelib}/orthos2/data/
cp -r orthos2/taskmanager/fixtures %{buildroot}%{python3_sitelib}/orthos2/taskmanager/
cp -r orthos2/frontend/templates %{buildroot}%{python3_sitelib}/orthos2/frontend/
mkdir -p %{buildroot}/var/log/orthos2

%pre
getent group orthos >/dev/null || groupadd -r orthos
getent passwd orthos >/dev/null || \
    useradd -r -g orthos -d /home/orthos -s /sbin/nologin \
    -c "Useful comment about the purpose of this account" orthos
%service_add_pre orthos2.service orthos2_taskmanager.service orthos2.socket

%post
%service_add_post orthos2.service orthos2_taskmanager.service orthos2.socket


%preun
%service_del_preun  orthos2.service orthos2_taskmanager.service orthos2.socket

%postun
%service_del_postun  orthos2.service orthos2_taskmanager.service orthos2.socket



%files
%{python3_sitelib}/orthos2-*
%attr(-,orthos, orthos) %{python3_sitelib}/orthos2/
%attr(744, orthos, orthos)%{python3_sitelib}/orthos2/manage.py
%attr(755, orthos, orthos) %dir /var/log/orthos2
%attr(644, root, root) %_unitdir/orthos2_taskmanager.service
%attr(644, root, root) %_unitdir/orthos2.service
%attr(644, root, root) %_unitdir/orthos2.socket
%if 0%{?suse_version}
%{_sbindir}/rcorthos2_taskmanager
%{_sbindir}/rcorthos2
%endif
%config(noreplace) %{_sysconfdir}/nginx/conf.d/orthos2_nginx.conf
%dir %{_sysconfdir}/nginx
%dir %{_sysconfdir}/nginx/conf.d
%dir /usr/share/orthos2/
%dir /srv/www/orthos2
%dir /srv/www/orthos2/static
/srv/www/orthos2/static/*
%attr(644, orthos, orthos) /usr/share/orthos2/orthos2_uwsgi.ini

%changelog
*Tue Sep 15 00:26:20 UTC 2020 - Thomas Renninger <trenn@suse.de>
- First submissions
